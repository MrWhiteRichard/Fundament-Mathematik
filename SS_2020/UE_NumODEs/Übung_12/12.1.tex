\begin{exercise}
  Formulieren Sie, basierend auf dem Newton-Verfahren, einen Algorithmus für das
  Mehrzielverfahren (Ende Abschnitt $7.2$ des Vorlesungsskriptes). Orientieren
  Sie sich dabei an Alg. $7.4$ für das einfache Schießverfahren. Geben Sie auch
  die benötigte Jacobi Matrix an.
\end{exercise}

\begin{solution}
  Die zu lösende Funktion in unserem Fall lautet mit $Y = (y_1,\dots,y_{N-1}),
  S := (s_0,\dots,s_{N-1})$ und $y_0 := y_a, y_N := y_b$
  \begin{align*}
    G(Y,S) = \begin{pmatrix}
    y_{x_0,y_0,s_0}(x_1) \\
    \dots \\
    y_{x_{N-1},y_{N-1},s_{N-1}}(x_N) \\
    y^{\prime}_{x_0,y_0,s_0}(x_1) \\
    \dots \\
    y^{\prime}_{x_{N-2},y_{N-2}s_{N-2}}(x_{N-1})) \\
    \end{pmatrix}
    - \begin{pmatrix}
      y_1 \\ \dots \\ y_N \\ s_1 \\ \dots \\ s_{N-1}
  \end{pmatrix}
    \stackrel{!}{=} 0,
  \end{align*}
  wobei $y_{x_i,y_i,s_i}$ die Lösung zum Anfangwertproblem
  \begin{align*}
    y^{\primeprime}(x) = f(x,y(x),y^{\prime}(x)), \quad y(x_i) = y_i, \quad y^{\prime}(x_i) = s_i
  \end{align*}
  beschreibt.
  Die Jacobi-Matrix davon lautet
  \begin{align*}
    DG(Y,S) = \begin{pmatrix}
      A & B \\ C & D
  \end{pmatrix}
  \end{align*}
  mit den Notationsabkürzungen
  $v_{y_i} := \partial_{y_i}y_{x_i,y_i,s_i}(x_{i+1})$,
  $v_{y^{\prime}_i} := \partial_{y_i}y^{\prime}_{x_i,y_i,s_i}(x_{i+1})$,
  $v_{s_i} := \partial_{s_i}y_{x_i,y_i,s_i}(x_{i+1})$ und
  $v_{s^{\prime}_i} := \partial_{s_i}y^{\prime}_{x_i,y_i,s_i}(x_{i+1})$.
  \begin{align*}
    A &= \begin{pmatrix}
    -1 & 0 & \hdots & 0\\
      v_{y_1} & -1 & \ddots & \vdots\\
      0 & \ddots & \ddots & 0\\
      \vdots & \ddots & \ddots & -1\\
      0 & \hdots & 0 & v_{y_{N-1}}\\
  \end{pmatrix} \in \R^{N \times (N-1)}, \quad
  B = \begin{pmatrix}
  v_{s_0} & 0 & \hdots & 0 \\
   0 & v_{s_1} & \ddots & \vdots\\
   \vdots & \ddots & \ddots & 0 \\
   0 & \hdots & 0 & v_{s_{N-1}}\\
\end{pmatrix} \in \R^{N \times N} \\
C &= \begin{pmatrix}
 0 &\hdots & \hdots & \hdots & 0\\
 v_{y^{\prime}_1} & \ddots & & & \vdots\\
 0 & \ddots &  \ddots& & \vdots \\
 \vdots & \ddots & \ddots &  \ddots & \vdots\\
 0 & \hdots & 0 & v_{y^{\prime}_{N-2}} & 0 \\
\end{pmatrix} \in \R^{(N-1)\times(N-1)}, \quad
D = \begin{pmatrix}
  v_{s^{\prime}_0} & -1 & 0 & \hdots & 0\\
  0 & \ddots & \ddots  & & \vdots \\
  \vdots & 0 & \ddots & -1 & 0\\
  0 & \hdots & 0 & v_{s^{\prime}_{N-2}} & -1\\
\end{pmatrix} \in \R^{(N-1)\times N}
  \end{align*}
Um das Newton-Verfahren anwenden zu können, müssen wir noch die partiellen
Ableitungen nach $s_i$ und $y_i$ berechnen. Dies gelingt erstens mit Lemma 7.3, welches
besagt, dass $v_{s_i}, i = 0,\dots,N-2$ die Lösung der Differentialgleichung
\begin{align*}
  v^{\primeprime}(x) = f_y(x,y_{x_i,y_i,s_i}(x),y_{x_i,y_i,s_i}^{\prime}(x))v(x)
  + f_{y^{\prime}}(x,y_{x_i,y_i,s_i}(x),y_{x_i,y_i,s_i}^{\prime}(x))v^{\prime}(x), \quad v(a) = 0, v^{\prime}(a) = 1.
\end{align*}
ist. Durch Vertauschen der Ableitungen erhalten wir damit auch
\begin{align*}
  v_{s^{\prime}_i} = \partial_{s_i}y^{\prime}_{x_i,y_i,s_i}(x_{i+1})
  = \partial_x \partial_{s_i}y_{x_i,y_i,s_i}(x_{i+1}) = v_{s_i}^{\prime}.
\end{align*}
Die Ableitung nach $y_i$ lässt sich ebenfalls als Lösung dieser Differentialgleichung
darstellen mit vertauschten Startwerten:
\begin{align*}
  v^{\primeprime}(x) = f_y(x,y_{x_i,y_i,s_i}(x),y_{x_i,y_i,s_i}^{\prime}(x))v(x)
  + f_{y^{\prime}}(x,y_{x_i,y_i,s_i}(x),y_{x_i,y_i,s_i}^{\prime}(x))v^{\prime}(x), \quad v(a) = 1, v^{\prime}(a) = 0.
\end{align*}
Wieder gilt $v_{y^{\prime}_i} = v_{y_i}^{\prime}$.
  \begin{algorithm}[caption={Mehrzielverfahren.}, label={alg1}]
   Input: Problembeschreibung $(f,a,b,y_a,y_b)$, Mesh $T = [x_0,\dots,x_N]$, Startwerte $S_0 = [s_0^0,\dots,s_{N-1}^0], Y_0 = [y_1^0,\dots,y_{N-1}^0]$.
   n := 0
   repeat
      for $i = 0,\dots,N-1$ do
        Berechne $y_{x_i^n,y_i^n,s_i^n}$ numerisch
      end for
      for $i = 0,\dots,N-1$ do
        Berechne $(v_{s_i^n},v_{s_i^n}^{\prime})$ numerisch
        Berechne $(v_{y_i^n},v_{y_i^n}^{\prime})$ numerisch
      end for
      Loese LGS $DG(S_n,Y_n)(\Delta(S_n),\Delta(Y_n)] = -G(S_n,Y_n)$
      $[S_{n+1},Y_{n+1}] = [S_n,Y_n] + [\Delta(S_n),\Delta(Y_n)]$
   until Abbruchkriterium des Newton-Verfahren erreicht.
   n = n + 1
   Output: Approximationen $(y_{x_i^{n-1},y_i^{n-1},s_i^{n-1}})_{i=1}^N$
  \end{algorithm}
\end{solution}
