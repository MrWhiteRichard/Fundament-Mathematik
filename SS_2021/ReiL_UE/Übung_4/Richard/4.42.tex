% -------------------------------------------------------------------------------- %

\begin{exercise}[Exercise 7.1]

In Chapter 5 we noted that the Monte Carlo error can be written as the sum of TD errors \eqref{eq:6.6} if thevalue estimates don't change from step to step.
Show that th $n$-step error used in \eqref{eq:7.2} can also be written as a sum TD errors (again if the value estimates don't change) generalizing the earlier result.

\begin{align} \label{eq:6.6} \tag{6.6}
    G_t - V(S_t)
    =
    \sum_{k=t}^{T-1}
        \gamma^{k-t}
        \delta_k
\end{align}

\begin{align} \label{eq:7.2} \tag{7.2}
    V_{t+n}(S_t)
    \doteq
    V_{t+n-1}(S_t) + \alpha [G_{t:t+n} - V_{t+n-1}(S_t)],
    \quad
    0 \leq t < T
\end{align}

\end{exercise}

% -------------------------------------------------------------------------------- %

\begin{solution}

\begin{align} \label{eq:6.5} \tag{6.5}
    \delta_t
    \doteq
    R_{t+1} + \gamma V(S_{t+1}) - V(S_t)
\end{align}

\begin{align} \label{eq:7.1} \tag{7.1}
    G_{t:t+n}
    \doteq
    R_{t+1} + \gamma R_{t+2} + \cdots + \gamma^{n-1} R_{t+n} + \gamma^n V_{t+n-1}(S_{t+n})
\end{align}

\begin{align*}
    G_{t:t+n} - V(S_t)
    & =
    R_{t+1} + \gamma G_{t+1:t+n} - V(S_t) + \gamma V(S_{t+1}) - \gamma V(S_{t+1}) \\
    & =
    \delta_t + \gamma (G_{t+1:t+n} - V(S_{t+1})) \\
    & =
    \delta_t + \gamma (\delta_{t+1} + \gamma (G_{t+2:t+n} - V(S_{t+2}))) \\
    & =
    \delta_t + \gamma \delta_{t+1} + \gamma^2 (G_{t+2:t+n} - V(S_{t+2})) \\
    & ~ \vdots \\
    & =
    \delta_t + \gamma \delta_{t+1} + \cdots + \gamma^{n-1} (G_{t+n-1:t+n} - V(S_{t+n-1})) \\
    & =
    \delta_t + \gamma \delta_{t+1} + \cdots + \gamma^{n-1} (R_{t+n} + \gamma V(S_{t+n}) - V(S_{t+n-1})) \\
    & =
    \sum_{k=t}^{n-1}
        \gamma^{k-t} \delta_k \\
    & =
    \sum_{k=t}^{\min \Bbraces{T-1, t-n-1}}
        \gamma^{k-t} \delta_k
\end{align*}

\end{solution}

% -------------------------------------------------------------------------------- %
