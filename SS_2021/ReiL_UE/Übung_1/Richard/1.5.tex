% --------------------------------------------------------------------------------

\begin{exercise}[Exercise 2.4]

If the step-size parameters, $\alpha_n$, are not constant, then the estimate $Q_n$ is a weighted average of previously received rewards with a weighting different from that given by \eqref{eq}.
What is the weighting on each prior reward for the general case, analogous to \eqref{eq}, in terms of the sequence of step-size parameters?

\begin{align} \label{eq}
    Q_{n+1}
    \doteq
    Q_n + \alpha \bbraces{R_n - Q_n}
    = \cdots =
    (1 - \alpha)^n Q_1
    +
    \sum_{i=1}^n
        \alpha (1 - \alpha)^{n-i} R_i
\end{align}

\end{exercise}

% --------------------------------------------------------------------------------

\begin{solution}

We will start with a formal calculation.

\begin{align*}
    &
    Q_{n+1} \\
    & =
    \alpha_n R_n + (1 - \alpha_n) Q_n \\
    & =
    \alpha_n R_n + (1 - \alpha_n) \bbraces{\alpha_{n-1} R_{n-1} + (1 - \alpha_{n-1}) Q_{n-1}} \\
    & =
    \alpha_n R_n + (1 - \alpha_n) \alpha_{n-1} R_{n-1} + (1 - \alpha_n) (1 - \alpha_{n-1}) Q_{n-1} \\
    & =
    \alpha_n R_n + (1 - \alpha_n) \alpha_{n-1} R_{n-1} + (1 - \alpha_n) (1 - \alpha_{n-1}) \bbraces{\alpha_{n-2} R_{n-2} + (1 - \alpha_{n-2}) Q_{n-2}} \\
    & =
    \alpha_n R_n + (1 - \alpha_n) \alpha_{n-1} R_{n-1} + (1 - \alpha_n) (1 - \alpha_{n-1}) \alpha_{n-2} R_{n-2} + (1 - \alpha_n) (1 - \alpha_{n-1}) (1 - \alpha_{n-2}) Q_{n-2} \\
    & = \cdots =
    \pbraces
    {
        \prod_{i=1}^n
            (1 - \alpha_i)
    }
    Q_1
    +
    \sum_{i=1}^n
        \pbraces
        {
            \alpha_i
            \prod_{j=i+1}^n
                (1 - \alpha_j)
        }
        R_i
\end{align*}

This can be proven by induction.
The base case ($n = 0$) is trivial, since the empty $\sum$ is $0$ and the empty $\prod$ is $1$.
For the induction step, let the upper expression hold for $n-1$.

\begin{align*}
    Q_{n+1}
    & =
    \alpha_n R_n + (1 - \alpha_n) Q_n \\
    & \stackrel
    {
        \text{IH}
    }{=}
    \alpha_n R_n + (1 - \alpha_n)
    \bbraces
    {
        \pbraces
        {
            \prod_{i=1}^{n-1}
                (1 - \alpha_i)
        }
        Q_1
        +
        \sum_{i=1}^{n-1}
            \pbraces
            {
                \alpha_i
                \prod_{j=i+1}^{n-1}
                    (1 - \alpha_j)
            }
            R_i
    } \\
    & =
    \alpha_n R_n
    +
    \pbraces
    {
        \prod_{i=1}^n
            (1 - \alpha_i)
    }
    Q_1
    +
    \sum_{i=1}^{n-1}
        \pbraces
        {
            \alpha_i
            \prod_{j=i+1}^n
                (1 - \alpha_j)
        }
        R_i \\
    & =
    \pbraces
    {
        \prod_{i=1}^n
            (1 - \alpha_i)
    }
    Q_1
    +
    \sum_{i=1}^n
        \pbraces
        {
            \alpha_i
            \prod_{j=i+1}^n
                (1 - \alpha_j)
        }
        R_i
\end{align*}

\end{solution}

% --------------------------------------------------------------------------------
